<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pmp.mapper.DicomMapper">

    <insert id="insertDicom" parameterType="com.pmp.domain.dicom.DicomDO">
        INSERT INTO ct_dicom (id, sop_instance_uid, patient_id, patient_name, accession_number,
                              study_id, series_number, instance_number,
                              series_date, series_time, study_description,
                              modality, series_description, rows, columns,
                              dicom_path, png_path, create_time)
        VALUES (null, #{sopInstanceUid}, #{patientId}, #{patientName}, #{accessionNumber},
                #{studyId}, #{seriesNumber}, #{instanceNumber},
                #{seriesDate}, #{seriesTime}, #{studyDescription},
                #{modality}, #{seriesDescription}, #{rows}, #{columns}, #{dicomPath}, #{pngPath}, now())
    </insert>

    <select id="selectDicomBySopInstanceUid" parameterType="com.pmp.domain.dicom.DicomDO"
            resultType="com.pmp.domain.dicom.DicomDO">
        SELECT id,
               sop_instance_uid   AS sopInstanceUid,
               patient_id         AS patientId,
               patient_name       AS patientName,
               accession_number   AS accessionNumber,
               study_id           AS studyId,
               series_number      AS seriesNumber,
               instance_number    AS instanceNumber,
               series_date        AS seriesDate,
               series_time        AS seriesTime,
               study_description  AS studyDescription,
               modality,
               series_description AS seriesDescription,
            rows,
            columns,
            create_time AS createTime
        FROM ct_dicom
        WHERE sop_instance_uid = #{sopInstanceUid}
    </select>

    <select id="findDicomByCondition" parameterType="com.pmp.web.vo.DicomVO"
            resultType="com.pmp.domain.dicom.DicomDO">
        SELECT id,
        sop_instance_uid AS sopInstanceUid,
        patient_id AS patientId,
        patient_name AS patientName,
        accession_number AS accessionNumber,
        study_id AS studyId,
        series_number AS seriesNumber,
        instance_number AS instanceNumber,
        series_date AS seriesDate,
        series_time AS seriesTime,
        study_description AS studyDescription,
        modality,
        series_description AS seriesDescription,
        rows,
        columns,
        dicom_path AS dicomPath,
        png_path AS pngPath,
        create_time AS createTime
        FROM ct_dicom
        <where>
            <if test="patientId != null and patientId != ''">
                AND patient_id LIKE CONCAT('%', #{patientId}, '%')
            </if>
            <if test="patientName != null and patientName != ''">
                AND patient_name LIKE CONCAT('%', #{patientName}, '%')
            </if>
            <if test="dateStart != null and dateStart != ''">
                AND create_time &gt;= #{dateStart}
            </if>
            <if test="dateEnd != null and dateEnd != ''">
                AND create_time &lt;= #{dateEnd}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>
    <select id="findDicomById" parameterType="com.pmp.web.vo.DicomVO"
            resultType="com.pmp.domain.dicom.DicomDO">
        SELECT id,
               sop_instance_uid   AS sopInstanceUid,
               patient_id         AS patientId,
               patient_name       AS patientName,
               accession_number   AS accessionNumber,
               study_id           AS studyId,
               series_number      AS seriesNumber,
               instance_number    AS instanceNumber,
               series_date        AS seriesDate,
               series_time        AS seriesTime,
               study_description  AS studyDescription,
               modality,
               series_description AS seriesDescription,
            rows,
            columns,
            dicom_path AS dicomPath,
            png_path AS pngPath,
            create_time AS createTime
        FROM ct_dicom
        WHERE id=#{id}
    </select>

    <select id="findGroupPictureByAccessionNumber" resultType="java.lang.String">
        SELECT png_path AS pngPath
        FROM ct_dicom
        WHERE accession_number = #{accessionNumber}
        ORDER BY instance_number
    </select>

    <select id="findReport" resultType="com.pmp.domain.report.ReportDO">
        SELECT id,
               patient_id           AS patientId,
               patient_name         AS patientName,
               accession_number     AS accessionNumber,
               is_positive          AS isPositive,
               positive_rate        AS positiveRate,
               pci_0_central        AS pci0Central,
               pci_1_right_upper    AS pci1RightUpper,
               pci_2_epigastrium    AS pci2Epigastrium,
               pci_3_left_upper     AS pci3LeftUpper,
               pci_4_left_flank     AS pci4LeftFlank,
               pci_5_left_lower     AS pci5LeftLower,
               pci_6_pelvis         AS pci6Pelvis,
               pci_7_right_lower    AS pci7RightLower,
               pci_8_right_flank    AS pci8RightFlank,
               pci_9_upper_jejunum  AS pci9UpperJejunum,
               pci_10_lower_jejunum AS pci10LowerJejunum,
               pci_11_upper_ileum   AS pci11UpperIleum,
               pci_12_lower_ileum   AS pci12LowerIleum,
               pci_score            AS pciScore,
               create_time          AS createTime
        FROM ct_report
        WHERE accession_number = #{accessionNumber}
    </select>

</mapper>