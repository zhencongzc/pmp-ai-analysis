<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pmp.infrastructure.mapper.DicomMapper">

    <resultMap id="dicomResultMap" type="com.pmp.domain.model.dicom.DicomDO">
        <id property="id" column="id"/>
        <result property="sopInstanceUid" column="sop_instance_uid"/>
        <result property="patientId" column="patient_id"/>
        <result property="patientName" column="patient_name"/>
        <result property="accessionNumber" column="accession_number"/>
        <result property="studyId" column="study_id"/>
        <result property="seriesNumber" column="series_number"/>
        <result property="instanceNumber" column="instance_number"/>
        <result property="seriesDate" column="series_date"/>
        <result property="seriesTime" column="series_time"/>
        <result property="studyDescription" column="study_description"/>
        <result property="modality" column="modality"/>
        <result property="seriesDescription" column="series_description"/>
        <result property="rows" column="rows"/>
        <result property="columns" column="columns"/>
        <result property="dicomPath" column="dicom_path"/>
        <result property="pngPath" column="png_path"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <insert id="insertDicom" parameterType="com.pmp.domain.model.dicom.DicomDO">
        INSERT INTO ct_dicom (id, sop_instance_uid, patient_id, patient_name, accession_number,
                              study_id, series_number, instance_number,
                              series_date, series_time, study_description,
                              modality, series_description, rows, columns,
                              dicom_path, png_path, create_time)
        VALUES (null, #{sopInstanceUid}, #{patientId}, #{patientName}, #{accessionNumber},
                #{studyId}, #{seriesNumber}, #{instanceNumber},
                #{seriesDate}, #{seriesTime}, #{studyDescription},
                #{modality}, #{seriesDescription}, #{rows}, #{columns}, #{dicomPath}, #{pngPath}, now())
    </insert>

    <insert id="insertReport">
        INSERT INTO ct_report (id,
                               patient_id,
                               patient_name,
                               accession_number,
                               is_positive,
                               positive_rate,
                               disease_type,
                               disease_level,
                               mesenteric_contracture,
                               pci_0_central,
                               pci_1_right_upper,
                               pci_2_epigastrium,
                               pci_3_left_upper,
                               pci_4_left_flank,
                               pci_5_left_lower,
                               pci_6_pelvis,
                               pci_7_right_lower,
                               pci_8_right_flank,
                               pci_9_upper_jejunum,
                               pci_10_lower_jejunum,
                               pci_11_upper_ileum,
                               pci_12_lower_ileum,
                               pci_score,
                               conclusion,
                               create_time)
        VALUES (null,
                #{patientId},
                #{patientName},
                #{accessionNumber},
                #{isPositive},
                #{positiveRate},
                #{diseaseType},
                #{diseaseLevel},
                #{mesentericContracture},
                #{pci0Central},
                #{pci1RightUpper},
                #{pci2Epigastrium},
                #{pci3LeftUpper},
                #{pci4LeftFlank},
                #{pci5LeftLower},
                #{pci6Pelvis},
                #{pci7RightLower},
                #{pci8RightFlank},
                #{pci9UpperJejunum},
                #{pci10LowerJejunum},
                #{pci11UpperIleum},
                #{pci12LowerIleum},
                #{pciScore},
                #{conclusion},
                now());
    </insert>

    <select id="selectDicomBySopInstanceUid" parameterType="com.pmp.domain.model.dicom.DicomDO"
            resultType="com.pmp.domain.model.dicom.DicomDO">
        SELECT id,
               sop_instance_uid   AS sopInstanceUid,
               patient_id         AS patientId,
               patient_name       AS patientName,
               accession_number   AS accessionNumber,
               study_id           AS studyId,
               series_number      AS seriesNumber,
               instance_number    AS instanceNumber,
               series_date        AS seriesDate,
               series_time        AS seriesTime,
               study_description  AS studyDescription,
               modality,
               series_description AS seriesDescription,
            rows,
            columns,
            create_time AS createTime
        FROM ct_dicom
        WHERE sop_instance_uid = #{sopInstanceUid}
    </select>

    <select id="findDicomByCondition" parameterType="com.pmp.interfaces.web.vo.DicomVO"
            resultType="com.pmp.domain.model.dicom.DicomDO">
        SELECT id,
        sop_instance_uid AS sopInstanceUid,
        patient_id AS patientId,
        patient_name AS patientName,
        accession_number AS accessionNumber,
        study_id AS studyId,
        series_number AS seriesNumber,
        instance_number AS instanceNumber,
        series_date AS seriesDate,
        series_time AS seriesTime,
        study_description AS studyDescription,
        modality,
        series_description AS seriesDescription,
        rows,
        columns,
        dicom_path AS dicomPath,
        png_path AS pngPath,
        create_time AS createTime
        FROM ct_dicom
        <where>
            <if test="patientId != null and patientId != ''">
                AND patient_id LIKE CONCAT('%', #{patientId}, '%')
            </if>
            <if test="patientName != null and patientName != ''">
                AND patient_name LIKE CONCAT('%', #{patientName}, '%')
            </if>
            <if test="dateStart != null and dateStart != ''">
                AND create_time &gt;= #{dateStart}
            </if>
            <if test="dateEnd != null and dateEnd != ''">
                AND create_time &lt;= #{dateEnd}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <select id="findDicomGroupByCondition" parameterType="com.pmp.interfaces.web.vo.DicomVO"
            resultMap="dicomResultMap">
        SELECT
        MIN(id) AS id,
        MAX(sop_instance_uid) AS sopInstanceUid,
        MAX(patient_id) AS patientId,
        MAX(patient_name) AS patientName,
        accession_number AS accessionNumber,
        MAX(study_id) AS studyId,
        MAX(series_number) AS seriesNumber,
        MAX(instance_number) AS instanceNumber,
        MAX(series_date) AS seriesDate,
        MAX(series_time) AS seriesTime,
        MAX(study_description) AS studyDescription,
        MAX(modality) AS modality,
        MAX(series_description) AS seriesDescription,
        MAX(rows) AS rows,
        MAX(columns) AS columns,
        MAX(dicom_path) AS dicomPath,
        MAX(png_path) AS pngPath,
        MAX(create_time) AS createTime,
        GROUP_CONCAT(instance_number ORDER BY instance_number ASC SEPARATOR ',') AS instanceNumbers,
        COUNT(*) AS count
        FROM ct_dicom
        GROUP BY accession_number
        <where>
            <if test="patientId != null and patientId != ''">
                AND patient_id LIKE CONCAT('%', #{patientId}, '%')
            </if>
            <if test="patientName != null and patientName != ''">
                AND patient_name LIKE CONCAT('%', #{patientName}, '%')
            </if>
            <if test="dateStart != null and dateStart != ''">
                AND create_time &gt;= #{dateStart}
            </if>
            <if test="dateEnd != null and dateEnd != ''">
                AND create_time &lt;= #{dateEnd}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <select id="findDicomGroupByAccessionNumber" resultType="com.pmp.domain.model.dicom.DicomGroupDTO">
        SELECT MAX(patient_id)         AS patientId,
               MAX(patient_name)       AS patientName,
               accession_number        AS accessionNumber,
               MAX(study_id)           AS studyId,
               MAX(series_number)      AS seriesNumber,
               COUNT(*)                AS instanceCount,
               MAX(series_date)        AS seriesDate,
               MAX(series_time)        AS seriesTime,
               MAX(study_description)  AS studyDescription,
               MAX(modality)           AS modality,
               MAX(series_description) AS seriesDescription
        FROM ct_dicom
        WHERE accession_number = #{accessionNumber}
        GROUP BY accession_number
    </select>

    <select id="findDicomById" parameterType="com.pmp.interfaces.web.vo.DicomVO"
            resultType="com.pmp.domain.model.dicom.DicomDO">
        SELECT id,
               sop_instance_uid   AS sopInstanceUid,
               patient_id         AS patientId,
               patient_name       AS patientName,
               accession_number   AS accessionNumber,
               study_id           AS studyId,
               series_number      AS seriesNumber,
               instance_number    AS instanceNumber,
               series_date        AS seriesDate,
               series_time        AS seriesTime,
               study_description  AS studyDescription,
               modality,
               series_description AS seriesDescription,
            rows,
            columns,
            dicom_path AS dicomPath,
            png_path AS pngPath,
            create_time AS createTime
        FROM ct_dicom
        WHERE id=#{id}
    </select>

    <select id="findDicomByAccessionNumber" resultType="com.pmp.domain.model.dicom.DicomDO">
        SELECT id,
               sop_instance_uid   AS sopInstanceUid,
               patient_id         AS patientId,
               patient_name       AS patientName,
               accession_number   AS accessionNumber,
               study_id           AS studyId,
               series_number      AS seriesNumber,
               instance_number    AS instanceNumber,
               series_date        AS seriesDate,
               series_time        AS seriesTime,
               study_description  AS studyDescription,
               modality,
               series_description AS seriesDescription,
            rows,
            columns,
            dicom_path AS dicomPath,
            png_path AS pngPath,
            create_time AS createTime
        FROM ct_dicom
        WHERE accession_number=#{accessionNumber}
            LIMIT 1
    </select>

    <select id="findGroupPictureByAccessionNumber" resultType="java.lang.String">
        SELECT png_path AS pngPath
        FROM ct_dicom
        WHERE accession_number = #{accessionNumber}
        ORDER BY instance_number
    </select>

    <select id="findReport" resultType="com.pmp.domain.model.report.ReportDO">
        SELECT id,
               patient_id             AS patientId,
               patient_name           AS patientName,
               accession_number       AS accessionNumber,
               is_positive            AS isPositive,
               positive_rate          AS positiveRate,
               disease_type           AS diseaseType,
               disease_level          AS diseaseLevel,
               mesenteric_contracture AS mesentericContracture,
               pci_0_central          AS pci0Central,
               pci_1_right_upper      AS pci1RightUpper,
               pci_2_epigastrium      AS pci2Epigastrium,
               pci_3_left_upper       AS pci3LeftUpper,
               pci_4_left_flank       AS pci4LeftFlank,
               pci_5_left_lower       AS pci5LeftLower,
               pci_6_pelvis           AS pci6Pelvis,
               pci_7_right_lower      AS pci7RightLower,
               pci_8_right_flank      AS pci8RightFlank,
               pci_9_upper_jejunum    AS pci9UpperJejunum,
               pci_10_lower_jejunum   AS pci10LowerJejunum,
               pci_11_upper_ileum     AS pci11UpperIleum,
               pci_12_lower_ileum     AS pci12LowerIleum,
               pci_score              AS pciScore,
               conclusion,
               create_time            AS createTime
        FROM ct_report
        WHERE accession_number = #{accessionNumber}
        ORDER BY createTime DESC LIMIT 1
    </select>


</mapper>